<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>상품 검색</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        img {
            max-width: 150px;
            height: auto;
        }

        a {
            text-decoration: none;
            color: blue;
        }
    </style>
</head>
<body>
<h1>상품 검색 결과</h1>

<form id="searchForm">
    <label for="category1">대분류:</label>
    <select id="category1" name="category1" onchange="loadSubcategories('category1', 'category2')">
        <option value="">-- 선택하세요 --</option>
    </select>

    <label for="category2">중분류:</label>
    <select id="category2" name="category2" onchange="loadSubcategories('category2', 'category3')">
        <option value="">-- 선택하세요 --</option>
    </select>

    <label for="category3">소분류:</label>
    <select id="category3" name="category3" onchange="loadSubcategories('category3', 'category4')">
        <option value="">-- 선택하세요 --</option>
    </select>

    <label for="category4">세부분류:</label>
    <select id="category4" name="category4" onchange="this.form.submit()">
        <option value="">-- 선택하세요 --</option>
    </select>

    <label for="searchQuery">검색어:</label>
    <input type="text" id="searchQuery" name="searchQuery">

    <button type="button" onclick="performSearch()">검색</button>
</form>

<h3>최근 검색 기록</h3>
<div id="searchHistoryArea" style="display: flex; overflow-x: auto; gap: 10px; flex-wrap: nowrap;">
    <!-- 검색 결과를 여기에 동적으로 추가 -->
</div>
<h2>검색 결과</h2>
<table id="resultsTable">
    <thead>
    <tr>
        <th>이미지</th>
        <th>상품명</th>
        <th>가격</th>
        <th>카테고리</th>
        <th>상세 링크</th>
        <th>위시리스트 추가</th>
    </tr>
    </thead>
    <tbody id="resultsBody">
    <!-- 검색 결과 데이터가 여기에 삽입 -->
    </tbody>
</table>

<script>
    async function loadCategory1() {
        const response = await fetch('/api/products/category1');
        const categories = await response.json();
        const select = document.getElementById('category1');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            select.appendChild(option);
        });
        await performSearch(); // 초기 로드 시 모든 상품 표시
    }
    function addToWishlist(productId) {
        fetch('/users/wishlist/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({ productId: productId })
        })
            .then(response => response.text())
            .then(message => {
                alert(message); // 서버에서 반환된 메시지 표시
            })
            .catch(error => {
                console.error('Error adding to wishlist:', error);
                alert('에러가 발생했습니다.');
            });
    }

    async function loadSubcategories(currentCategoryId, targetCategoryId) {
        const selectedValue = document.getElementById(currentCategoryId).value;
        const targetSelect = document.getElementById(targetCategoryId);
        targetSelect.innerHTML = '<option value="">-- 선택하세요 --</option>';

        if (!selectedValue) return;

        const endpoint = `/api/products/${targetCategoryId}?${currentCategoryId}=${selectedValue}`;
        const response = await fetch(endpoint);
        const categories = await response.json();

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            targetSelect.appendChild(option);
        });
    }
    async function loadSearchHistory() {
        const response = await fetch('/api/search-history');
        const history = await response.json();

        const searchHistoryArea = document.getElementById('searchHistoryArea');
        searchHistoryArea.innerHTML = ''; // 이전 기록을 지움
        history.forEach(item => {
            const historyItem = document.createElement('li');
            historyItem.textContent = item.history;
            searchHistoryArea.appendChild(historyItem);
        });
    }
    async function performSearch() {
        const formData = new FormData(document.getElementById('searchForm'));
        const searchQueryString = new URLSearchParams(formData).toString();
        const response = await fetch(`/api/products/search?${searchQueryString}`);
        const results = await response.json();

        // 검색어를 서버로 전송하여 기록을 저장하도록 함
        const searchQuery = formData.get('searchQuery');  // 검색어 가져오기
        if (searchQuery) {
            const historyResponse = await fetch('/api/search-history', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ history: searchQuery })
            });
            const message = await historyResponse.text();
            alert(message);
        }

        const resultsBody = document.getElementById('resultsBody');
        resultsBody.innerHTML = results.map(product => `
            <tr>
                <td><img src="${product.image}" alt="${product.title}"></td>
                <td>${product.title}</td>
                <td>${product.lprice} 원</td>
                <td>${product.category1} > ${product.category2} > ${product.category3} > ${product.category4}</td>
                <td><a href="${product.link}" target="_blank">상세 보기</a></td>
           <td>
                <button onclick="addToWishlist(${product.id})">위시리스트 추가</button>
            </td>
            </tr>
        `).join('');

        loadSearchHistory();
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadCategory1(); // 카테고리1 초기 로드
        loadSearchHistory(); //최근 검색기록 로드
        // 엔터 키로 폼 제출 방지
        document.getElementById('searchForm').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // 기본 동작 차단
                performSearch(); // 검색 로직 실행
            }
        });
    });
</script>

</body>
</html>
