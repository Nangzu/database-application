<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>상품 검색</title>
    <!-- 외부 CSS 파일을 링크 -->
    <link rel="stylesheet" href="/css/search_results.css">
    <link rel="stylesheet" href="/css/mypage-modal.css">

</head>
<body>
<h1>
    @@@@김석윤의 최저가 사이트@@@@
    <div class="header-fixed">
        <div class="button-section">
        <span th:if="${loggedInUser != null}">
            <a href="/users/mypage">
                <button class="mypage-button">마이페이지</button>
            </a>
            <a href="/users/logout">
                <button class="logout-button">로그아웃</button>
            </a>
        </span>
            <span th:if="${loggedInUser == null}">
            <a href="/users/login">
                <button class="login-button">로그인</button>
            </a>
            <a href="/users/register">
                <button class="register-button">회원가입</button>
            </a>
        </span>
        </div>
        <span th:if="${loggedInUser != null}" class="user-info">
        안녕하세요, <span th:text="${loggedInUser.username}"></span>님
    </span>
    </div>
</h1>
<h1>@@@@@@@@@@스탠바이미 50만원에팜@@@@@@@@@@@@</h1>
<div class="banner-container">
    <img src="/images/last.jpg" alt="왼쪽" class="banner-image left-banner">
    <img src="/images/stan.jpg" alt="가운데" class="banner-image center-banner">
    <img src="/images/funny.jpg" alt="오른쪽" class="banner-image right-banner">
</div>
<form id="searchForm">
    <div class="search-bar-section">
        <label for="searchQuery">검색어:</label>
        <input type="text" id="searchQuery" name="searchQuery" placeholder="검색어를 입력하세요...">
        <button type="button" onclick="performSearch()">검색</button>
    </div>
    <div id="searchHistoryArea" style="display: flex; overflow-x: auto; gap: 10px; flex-wrap: nowrap;">
    </div>
    <div class="category-section">
        <label for="category1">대분류:</label>
        <select id="category1" name="category1" onchange="loadSubcategories('category1', 'category2')">
            <option value="">-- 선택하세요 --</option>
        </select>

        <label for="category2">중분류:</label>
        <select id="category2" name="category2" onchange="loadSubcategories('category2', 'category3')">
            <option value="">-- 선택하세요 --</option>
        </select>

        <label for="category3">소분류:</label>
        <select id="category3" name="category3" onchange="loadSubcategories('category3', 'category4')">
            <option value="">-- 선택하세요 --</option>
        </select>

        <label for="category4">세부분류:</label>
        <select id="category4" name="category4" onchange="">
            <option value="">-- 선택하세요 --</option>
        </select>
    </div>
</form>




<table id="resultsTable">
<!--    <thead>-->
<!--    <tr>-->
<!--        <th>이미지</th>-->
<!--        <th>상품명</th>-->
<!--        <th>가격</th>-->
<!--        <th>카테고리</th>-->
<!--        <th>상세 링크</th>-->
<!--        <th>위시리스트 추가</th>-->
<!--    </tr>-->
<!--    </thead>-->
    <tbody id="resultsBody">
    <!-- 검색 결과 데이터가 여기에 삽입 -->
    </tbody>
</table>

<nav>
    <ul class="pagination">
        <!-- 이전 페이지 버튼 -->
        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
            <a class="page-link" th:href="@{/main(searchQuery=${searchQuery}, category1=${category1}, category2=${category2}, category3=${category3}, category4=${category4}, page=${currentPage - 1}, size=${size})}">Previous</a>
        </li>

        <!-- 시작 페이지 ... 이전 페이지와 현재 페이지까지 -->
        <li class="page-item" th:if="${startPage > 1}">
            <span class="page-link">...</span>
        </li>

        <!-- 페이지 번호 (범위 내 페이지들) -->
        <li class="page-item" th:each="i : ${#numbers.sequence(startPage, endPage)}" th:classappend="${i == currentPage + 1} ? 'active'">
            <a class="page-link" th:href="@{/main(searchQuery=${searchQuery}, category1=${category1}, category2=${category2}, category3=${category3}, category4=${category4}, page=${i - 1}, size=${size})}" th:text="${i}"></a>
        </li>

        <!-- 끝 페이지 ... 이후 페이지와 마지막 페이지까지 -->
        <li class="page-item" th:if="${endPage < totalPages}">
            <span class="page-link">...</span>
        </li>

        <!-- 다음 페이지 버튼 -->
        <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
            <a class="page-link" th:href="@{/main(searchQuery=${searchQuery}, category1=${category1}, category2=${category2}, category3=${category3}, category4=${category4}, page=${currentPage + 1}, size=${size})}">Next</a>
        </li>
    </ul>
</nav>







<script>
    let currentPage = 0;  // 기본 페이지
    let totalPages = 1;   // 총 페이지 수

    async function goToPage(pageNumber) {
        currentPage = pageNumber; // 페이지 번호를 업데이트
        await performSearch();     // 새로운 페이지에 대한 검색 수행
    }

    function openMypageModal() {
        document.getElementById('mypageModal').style.display = 'block';
    }

    function closeMypageModal() {
        document.getElementById('mypageModal').style.display = 'none';
    }

    async function loadCategory1() {
        const response = await fetch('/api/products/category1');
        const categories = await response.json();
        const select = document.getElementById('category1');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            select.appendChild(option);
        });
        await performSearch(); // 초기 로드 시 모든 상품 표시
    }

    async function loadSubcategories(currentCategoryId, targetCategoryId) {
        const selectedValue = document.getElementById(currentCategoryId).value;
        const targetSelect = document.getElementById(targetCategoryId);
        targetSelect.innerHTML = '<option value="">-- 선택하세요 --</option>';

        if (!selectedValue) return;

        const endpoint = `/api/products/${targetCategoryId}?${currentCategoryId}=${selectedValue}`;
        const response = await fetch(endpoint);
        const categories = await response.json();

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            targetSelect.appendChild(option);
        });
    }

    async function loadSearchHistory() {
        const response = await fetch('/api/search-history');
        const history = await response.json();

        const searchHistoryArea = document.getElementById('searchHistoryArea');
        searchHistoryArea.innerHTML = ''; // 이전 기록을 지움
        history.forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.classList.add('history-item');
            historyItem.textContent = item.history;
            searchHistoryArea.appendChild(historyItem);
        });
    }

    async function performSearch() {
        const formData = new FormData(document.getElementById('searchForm'));
        formData.append('size', 5);  // 페이지당 항목 수
        formData.append('page', currentPage);  // 현재 페이지 추가

        const searchQueryString = new URLSearchParams(formData).toString();
        const response = await fetch(`/api/products/search?${searchQueryString}`);
        const results = await response.json();

        // 서버에서 받은 데이터를 처리
        const products = results.products;
        currentPage = results.currentPage;
        totalPages = results.totalPages;
        const totalItems = results.totalItems;

        // 검색어를 서버로 전송하여 기록을 저장하도록 함
        const searchQuery = formData.get('searchQuery');  // 검색어 가져오기
        if (searchQuery) {
            await fetch('/api/search-history', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ history: searchQuery })
            });
        }

        // 검색 결과를 렌더링
        const resultsBody = document.getElementById('resultsBody');
        resultsBody.innerHTML = products.map(product => `
        <tr>
            <td><img src="${product.image}" alt="${product.title}"></td>
            <td><a href="/products/${product.id}">${product.title}</a></td>
            <td>${product.lprice} 원</td>
            <td>${product.category1} > ${product.category2} > ${product.category3} > ${product.category4}</td>
            <td><a href="${product.link}" target="_blank">상세 보기</a></td>
            <td>
                <form method="POST" action="/users/wishlist/add">
                    <input type="hidden" name="productId" value="${product.id}">
                    <button type="submit" class="wishlist-button">위시리스트 추가</button>
                </form>
            </td>
        </tr>
        `).join('');

        // 페이지 정보 업데이트
        document.querySelector(".pagination").innerHTML = renderPagination();

        // 전체 항목 수 표시
        document.querySelector("p[th\\:text='${totalItems}']").textContent = `전체 상품: ${totalItems}`;
        document.querySelector("p[th\\:text='${totalPages}']").textContent = `총 페이지 수: ${totalPages}`;
        document.querySelector("p[th\\:text='${currentPage + 1}']").textContent = `현재 페이지: ${currentPage + 1}`;

        // 검색 기록 갱신
        await loadSearchHistory();
    }

    function renderPagination() {
        let paginationHTML = "";

        // 이전 페이지 버튼
        paginationHTML += `
        <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
            <a class="page-link" href="javascript:goToPage(${currentPage - 1})">이전</a>
        </li>`;

        // 시작 페이지 ... 이전 페이지와 현재 페이지까지
        if (currentPage > 2) {
            paginationHTML += `<li class="page-item"><span class="page-link">...</span></li>`;
        }

        // 페이지 번호
        for (let i = Math.max(0, currentPage - 2); i <= Math.min(totalPages - 1, currentPage + 2); i++) {
            paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="javascript:goToPage(${i})">${i + 1}</a>
            </li>`;
        }

        // 끝 페이지 ... 이후 페이지와 마지막 페이지까지
        if (currentPage < totalPages - 3) {
            paginationHTML += `<li class="page-item"><span class="page-link">...</span></li>`;
        }

        // 다음 페이지 버튼
        paginationHTML += `
        <li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
            <a class="page-link" href="javascript:goToPage(${currentPage + 1})">다음</a>
        </li>`;

        return paginationHTML;
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadCategory1(); // 카테고리1 초기 로드
        loadSearchHistory(); // 최근 검색기록 로드

        // 엔터 키로 폼 제출 방지
        document.getElementById('searchForm').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // 기본 동작 차단
                performSearch(); // 검색 로직 실행
            }
        });
    });

</script>


</body>
</html>